import React, { useState, useCallback } from 'react';
import { Stack, Card, Text, Button, Box, Flex, TextArea, TextInput } from '@sanity/ui';
import { set, unset } from 'sanity';
import { PasteIcon, TrashIcon, EditIcon } from '@sanity/icons';

// Generate unique key for Sanity
function generateKey() {
    return `row_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
}

export function TablePasteInput(props) {
    const { value, onChange } = props;
    const [pasteText, setPasteText] = useState('');
    const [showPasteArea, setShowPasteArea] = useState(false);
    const [editingCell, setEditingCell] = useState<{ row: number, col: number } | null>(null);
    const [editValue, setEditValue] = useState('');
    const [parseError, setParseError] = useState<string | null>(null);

    // Parse pasted table data - IMPROVED for markdown tables
    const parseTable = useCallback((text: string) => {
        if (!text.trim()) return null;

        setParseError(null);

        try {
            // Split by lines and remove empty lines
            let lines = text.trim().split('\n').map(line => line.trim()).filter(line => line);

            if (lines.length === 0) return null;

            // Check if it's a markdown table (starts with |)
            const isMarkdown = lines[0].startsWith('|');
            let delimiter = '\t'; // Default to tab

            if (isMarkdown) {
                // Remove the markdown separator line (like |---|---|)
                lines = lines.filter(line => {
                    const cleaned = line.replace(/\|/g, '').trim();
                    // Check if line is just dashes and spaces
                    return !(/^[-‚Äì‚Äî\s]+$/.test(cleaned));
                });

                delimiter = '|';
            } else if (lines[0].includes('\t')) {
                delimiter = '\t';
            } else if (lines[0].includes(',')) {
                delimiter = ',';
            }

            // Parse rows with _key
            const rows = lines.map((line, index) => {
                let cells: string[];

                if (delimiter === '|') {
                    // For markdown tables: split by |, remove first and last empty items
                    cells = line
                        .split('|')
                        .map(cell => cell.trim())
                        .filter(cell => cell !== ''); // Remove empty cells from | at start/end
                } else {
                    cells = line
                        .split(delimiter)
                        .map(cell => cell.trim());
                }

                return {
                    _key: generateKey(),
                    cells
                };
            });

            // Filter out rows with no cells
            const validRows = rows.filter(row => row.cells.length > 0);

            if (validRows.length === 0) {
                setParseError('No valid rows found in the pasted data');
                return null;
            }

            // Ensure all rows have the same number of columns
            const maxColumns = Math.max(...validRows.map(row => row.cells.length));
            const normalizedRows = validRows.map(row => ({
                _key: row._key, // Keep the generated key
                cells: [
                    ...row.cells,
                    ...Array(maxColumns - row.cells.length).fill('')
                ]
            }));

            return {
                _type: 'table',
                onChange(unset());
}, [onChange]);

const handleQuickPaste = useCallback(async () => {
    try {
        const clipboardText = await navigator.clipboard.readText();
        const parsedTable = parseTable(clipboardText);

        if (parsedTable) {
            onChange(set(parsedTable));
            setParseError(null);
        } else {
            // Show paste area if parsing failed
            setPasteText(clipboardText);
            setShowPasteArea(true);
        }
    } catch (err) {
        console.error('Failed to read clipboard:', err);
        icon = { PasteIcon }
        text = "Quick Paste from Clipboard"
        tone = "primary"
        onClick = { handleQuickPaste }
        mode = "default"
            />
            { value && (
                <>
                    <Button
                        icon={EditIcon}
                        text="Add Row"
                        tone="positive"
                        onClick={handleAddRow}
                        mode="ghost"
                    />
                    <Button
                        icon={TrashIcon}
                        text="Clear Table"
                        tone="critical"
                        onClick={handleClear}
                        mode="ghost"
                    />
                </>
            )
    }
    <Button
        text={showPasteArea ? "Hide Paste Area" : "Manual Paste"}
        onClick={() => setShowPasteArea(!showPasteArea)}
        mode="ghost"
    />
</Flex >

    {/* Parse Error */ }
{
    parseError && (
        <Card padding={3} tone="critical" radius={2}>
            <Text size={1}>‚ö†Ô∏è {parseError}</Text>
        </Card>
    )
}

{/* Manual Paste Area */ }
{
    showPasteArea && (
        <Card padding={3} tone="primary" radius={2}>
            <Stack space={3}>
                <Text size={1} weight="semibold">
                    üìã Paste Your Table Data
                </Text>
                <Text size={1} muted>
                    Supports: Markdown tables (| ... |), Tab-separated, Comma-separated (CSV)
                </Text>
                <TextArea
                    value={pasteText}
                    onChange={(e) => setPasteText(e.currentTarget.value)}
                    placeholder="Paste table here...

Example Markdown:
| Header 1 | Header 2 |
| -------- | -------- |
| Cell 1   | Cell 2   |

Or tab/comma-separated data"
                    rows={10}
                    style={{ fontFamily: 'monospace', fontSize: '12px' }}
                />
                <Flex gap={2}>
                    <Button
                        text="Parse & Insert Table"
                        tone="positive"
                        onClick={handlePaste}
                        disabled={!pasteText.trim()}
                    />
                    <Button
                        text="Cancel"
                        mode="ghost"
                        onClick={() => {
                            setShowPasteArea(false);
                            setPasteText('');
                            setParseError(null);
                        }}
                    />
                </Flex>
            </Stack>
        </Card>
    )
}

{/* Current Table Preview with Inline Editing */ }
{
    value && value.rows && value.rows.length > 0 && (
        <Card padding={3} radius={2} tone="transparent" border>
            <Stack space={2}>
                <Flex justify="space-between" align="center">
                    <Text size={1} weight="semibold">
                        ‚úì Table Ready ({value.rows.length} rows √ó {value.rows[0]?.cells?.length || 0} columns)
                    </Text>
                    <Text size={1} muted>
                        Click any cell to edit
                    </Text>
                </Flex>

                {/* Editable Table */}
                <Box style={{ overflowX: 'auto' }}>
                    <table style={{
                        width: '100%',
                        borderCollapse: 'collapse',
                        fontSize: '13px',
                    }}>
                        <thead>
                            <tr style={{ backgroundColor: '#2276fc', color: 'white' }}>
                                {value.rows[0]?.cells?.map((cell: string, idx: number) => (
                                    <th
                                        key={idx}
                                        style={{
                                            padding: '10px',
                                            border: '1px solid #1d4ed8',
                                            textAlign: 'left',
                                            fontWeight: 600,
                                            cursor: 'pointer',
                                        }}
                                        onClick={() => handleCellClick(0, idx, cell)}
                                    >
                                        {editingCell?.row === 0 && editingCell?.col === idx ? (
                                            <div style={{ display: 'flex', gap: '4px' }}>
                                                <input
                                                    type="text"
                                                    value={editValue}
                                                    onChange={(e) => setEditValue(e.target.value)}
                                                    onKeyDown={(e) => {
                                                        if (e.key === 'Enter') handleCellSave();
                                                        if (e.key === 'Escape') handleCellCancel();
                                                    }}
                                                    autoFocus
                                                    style={{
                                                        flex: 1,
                                                        padding: '6px',
                                                        border: '2px solid #fbbf24',
                                                        borderRadius: '4px',
                                                        fontSize: '13px',
                                                    }}
                                                />
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        handleCellSave();
                                                    }}
                                                    style={{
                                                        padding: '4px 10px',
                                                        background: '#10b981',
                                                        color: 'white',
                                                        border: 'none',
                                                        borderRadius: '4px',
                                                        cursor: 'pointer',
                                                        fontSize: '12px',
                                                        fontWeight: 'bold',
                                                    }}
                                                >
                                                    ‚úì
                                                </button>
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        handleCellCancel();
                                                    }}
                                                    style={{
                                                        padding: '4px 10px',
                                                        background: '#ef4444',
                                                        color: 'white',
                                                        border: 'none',
                                                        borderRadius: '4px',
                                                        cursor: 'pointer',
                                                        fontSize: '12px',
                                                        fontWeight: 'bold',
                                                    }}
                                                >
                                                    ‚úó
                                                </button>
                                            </div>
                                        ) : (
                                            cell || '(empty)'
                                        )}
                                    </th>
                                ))}
                                <th style={{ padding: '10px', border: '1px solid #1d4ed8', width: '70px', textAlign: 'center' }}>
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {value.rows.slice(1).map((row: any, rowIdx: number) => (
                                <tr key={row._key || rowIdx} style={{ backgroundColor: rowIdx % 2 === 0 ? '#f9fafb' : 'white' }}>
                                    {row.cells?.map((cell: string, cellIdx: number) => (
                                        <td
                                            key={cellIdx}
                                            style={{
                                                padding: '10px',
                                                border: '1px solid #e5e7eb',
                                                cursor: 'pointer',
                                                backgroundColor: editingCell?.row === rowIdx + 1 && editingCell?.col === cellIdx ? '#fef3c7' : 'inherit',
                                                transition: 'background-color 0.2s',
                                            }}
                                            onClick={() => handleCellClick(rowIdx + 1, cellIdx, cell)}
                                            onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#f3f4f6'}
                                            onMouseLeave={(e) => {
                                                if (!(editingCell?.row === rowIdx + 1 && editingCell?.col === cellIdx)) {
                                                    e.currentTarget.style.backgroundColor = rowIdx % 2 === 0 ? '#f9fafb' : 'white';
                                                }
                                            }}
                                        >
                                            {editingCell?.row === rowIdx + 1 && editingCell?.col === cellIdx ? (
                                                <div style={{ display: 'flex', gap: '4px' }}>
                                                    <input
                                                        type="text"
                                                        value={editValue}
                                                        onChange={(e) => setEditValue(e.target.value)}
                                                        onKeyDown={(e) => {
                                                            if (e.key === 'Enter') handleCellSave();
                                                            if (e.key === 'Escape') handleCellCancel();
                                                        }}
                                                        autoFocus
                                                        style={{
                                                            flex: 1,
                                                            padding: '6px',
                                                            border: '2px solid #2276fc',
                                                            borderRadius: '4px',
                                                            fontSize: '13px',
                                                        }}
                                                    />
                                                    <button
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            handleCellSave();
                                                        }}
                                                        style={{
                                                            padding: '4px 10px',
                                                            background: '#10b981',
                                                            color: 'white',
                                                            border: 'none',
                                                            borderRadius: '4px',
                                                            cursor: 'pointer',
                                                            fontSize: '12px',
                                                            fontWeight: 'bold',
                                                        }}
                                                    >
                                                        ‚úì
                                                    </button>
                                                    <button
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            handleCellCancel();
                                                        }}
                                                        style={{
                                                            padding: '4px 10px',
                                                            background: '#ef4444',
                                                            color: 'white',
                                                            border: 'none',
                                                            borderRadius: '4px',
                                                            cursor: 'pointer',
                                                            fontSize: '12px',
                                                            fontWeight: 'bold',
                                                        }}
                                                    >
                                                        ‚úó
                                                    </button>
                                                </div>
                                            ) : (
                                                cell || <span style={{ color: '#9ca3af', fontStyle: 'italic' }}>(empty)</span>
                                            )}
                                        </td>
                                    ))}
                                    <td style={{ padding: '10px', border: '1px solid #e5e7eb', textAlign: 'center' }}>
                                        <button
                                            onClick={() => handleDeleteRow(rowIdx + 1)}
                                            style={{
                                                padding: '6px 12px',
                                                background: '#fee2e2',
                                                color: '#dc2626',
                                                border: '1px solid #fecaca',
                                                borderRadius: '4px',
                                                cursor: 'pointer',
                                                fontSize: '12px',
                                                fontWeight: 'bold',
                                            }}
                                            title="Delete this row"
                                        >
                                            üóëÔ∏è
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </Box>

                <Card padding={2} tone="transparent">
                    <Text size={0} muted>
                        üí° <strong>Tips:</strong> Click cell to edit ‚Ä¢ Enter = save ‚Ä¢ Escape = cancel
                    </Text>
                </Card>
            </Stack>
        </Card>
    )
}

{/* Help Text */ }
{
    !value && !showPasteArea && (
        <Card padding={4} tone="transparent" radius={2} border>
            <Stack space={3}>
                <Text size={2} weight="semibold">
                    üìã Quick Table Import
                </Text>
                <Stack space={2}>
                    <Text size={1}>
                        <strong>1.</strong> Copy a table from anywhere (ChatGPT, Perplexity, Excel, website)
                    </Text>
                    <Text size={1}>
                        <strong>2.</strong> Click "Quick Paste from Clipboard"
                    </Text>
                    <Text size={1}>
                        <strong>3.</strong> Table is instantly ready! Edit any cell by clicking it
                    </Text>
                </Stack>
                <Text size={1} muted>
                    Supports: Markdown tables, Tab-separated, CSV
                </Text>
            </Stack>
        </Card>
    )
}
        </Stack >
);
}
